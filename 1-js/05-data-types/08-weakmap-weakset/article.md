# WeakMap and WeakSetï¼ˆå¼±æ˜ å°„å’Œå¼±é›†åˆï¼‰

æˆ‘ä»¬ä»å‰é¢çš„[åƒåœ¾å›æ”¶](<info:garbage-collection>)ç« èŠ‚ä¸­çŸ¥é“ï¼ŒJavaScript å¼•æ“åœ¨å†…å­˜å……è¶³çš„æƒ…å†µä¸‹ï¼ˆæˆ–è€…å¯èƒ½è¢«ä½¿ç”¨å®Œï¼‰å­˜å‚¨ä¸€ä¸ªå€¼

ä¾‹å¦‚:
```js
let john = { name: "John" };

// è¯¥å¯¹è±¡èƒ½è¢«è®¿é—®, john æ˜¯å®ƒçš„å¼•ç”¨

// è¦†ç›–å¼•ç”¨
john = null;

*!*
// è¯¥å¯¹è±¡å°†ä¼šä»å†…å­˜ä¸­è¢«æ¸…é™¤
*/!*
```

é€šå¸¸ï¼Œå½“å¯¹è±¡çš„å±æ€§æˆ–è€…æ•°ç»„çš„å…ƒæˆ–è€…å…¶å®ƒæ•°æ®ç»“æ„è¢«è®¤ä¸ºæ˜¯å¯è®¿é—®çš„ï¼Œå¹¶åœ¨è¯¥æ•°æ®ç»“æ„å¤„äºå†…å­˜ä¸­æ—¶é©»ç•™åœ¨å†…å­˜ä¸­ã€‚

ä¾‹å¦‚, å¦‚æœæŠŠä¸€ä¸ªå¯¹è±¡æ”¾å…¥åˆ°æ•°ç»„ä¸­å», ç„¶åå½“æ•°ç»„ç•™å­˜åœ¨å†…å­˜ä¸­æ—¶ï¼Œç”šè‡³è¯¥å¯¹è±¡åœ¨æ²¡æœ‰å…¶å®ƒå¼•ç”¨çš„æƒ…å†µä¸‹ä¾æ—§ä¹Ÿæ˜¯å¯è®¿é—®çš„ ã€‚

å°±åƒè¿™æ ·:

```js
let john = { name: "John" };

let array = [ john ];

john = null; // è¦†ç›–å¼•ç”¨

*!*
// john è¢«å­˜å‚¨åœ¨æ•°ç»„é‡Œ, æ‰€ä»¥å®ƒä¸ä¼šè¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶
// æˆ‘ä»¬å¯ä»¥é€šè¿‡ array[0] æ¥è®¿é—®
*/!*
```

ç±»ä¼¼åœ°, å¦‚æœæˆ‘ä»¬åªç”¨å¯¹è±¡ä½œä¸ºå¸¸è§„ `Map` çš„é”®çš„æ—¶å€™, ç„¶åå½“ `Map` å­˜åœ¨æ—¶, é‚£ä¸ªå¯¹è±¡ä¹Ÿæ˜¯å­˜åœ¨çš„. å®ƒä¼šå ç”¨å†…å­˜å¹¶ä¸”å¯èƒ½ä¸ä¼šè¢«ï¼ˆåƒåœ¾å›æ”¶æœºåˆ¶ï¼‰å›æ”¶.

For instance:

```js
let john = { name: "John" };

let map = new Map();
map.set(john, "...");

john = null; // è¦†ç›–å¼•ç”¨

*!*
// john è¢«å­˜åœ¨ map é‡Œé¢äº†,
// æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ map.keys() æ¥å¾—åˆ°å®ƒ
*/!*
```

`WeakMap` åœ¨è¿™æ–¹é¢æœ‰ç€æ ¹æœ¬çš„åŒºåˆ«ã€‚å®ƒä¸ä¼šé˜»æ­¢åƒåœ¾å›æ”¶å¯¹å…³é”®å¯¹è±¡è¿›è¡Œå›æ”¶æ“ä½œã€‚

è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä¾‹å­é‡Œç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ„æ€

## WeakMap

ç›¸å¯¹äº `Map` ï¼Œ`WeakMap` çš„ç¬¬ä¸€ä¸ªä¸åŒç‚¹å°±æ˜¯å®ƒé”®å¿…é¡»æ˜¯å¯¹è±¡ï¼Œä¸èƒ½æ˜¯åŸå§‹å€¼

```js run
let weakMap = new WeakMap();

let obj = {};

weakMap.set(obj, "ok"); // æ­£å¸¸ (é”®å¯¹è±¡)

*!*
// ä¸èƒ½ä½¿ç”¨ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºé”®
weakMap.set("test", "Whoops"); // é”™è¯¯, å› ä¸º "test" ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡
*/!*
```

ç°åœ¨, å¦‚æœæˆ‘ä»¬åœ¨ weakMap é‡Œä½¿ç”¨å¯¹è±¡ä½œä¸ºé”®ï¼Œå¹¶ä¸”å½“è¿™ä¸ªå¯¹è±¡æ²¡æœ‰å…¶å®ƒå¼•ç”¨ -- è¯¥å¯¹è±¡å°†ä¼šä»å†…å­˜ä¸­è¢«è‡ªåŠ¨æ¸…é™¤ ( map ä¹Ÿç±»ä¼¼) ã€‚

```js
let john = { name: "John" };

let weakMap = new WeakMap();
weakMap.set(john, "...");

john = null; // è¦†ç›–å¼•ç”¨

// john ä»å†…å­˜ä¸­è¢«ç§»é™¤ï¼
```

ä¸ä¸Šé¢çš„å¸¸è§„ `Map` ä¾‹å­æ¯”èµ·æ¥ã€‚ ç°åœ¨å¦‚æœ `john` ä»…ä»…æ˜¯ä½œä¸º `WeakMap` çš„é”®è€Œå­˜åœ¨æ—¶ -- å®ƒå°†ä¼šä» map ï¼ˆä»å†…å­˜ä¸­ï¼‰è‡ªåŠ¨åˆ é™¤ã€‚

`WeakMap` ä¸æ”¯æŒè¿­ä»£å’Œ`keys()`, `values()`, `entries()`æ–¹æ³•, æ‰€ä»¥æ²¡æ³•ä»å®ƒé‡Œé¢è·å–é”®æˆ–è€…å€¼ã€‚

`WeakMap` åªæœ‰ä»¥ä¸‹æ–¹æ³•:

- `weakMap.get(key)`
- `weakMap.set(key, value)`
- `weakMap.delete(key)`
- `weakMap.has(key)`

ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§é™åˆ¶å‘¢? é‚£æ˜¯å› ä¸ºæŠ€æœ¯åŸå› ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡ä¸¢å¤±äº†å…¶å®ƒå¤šæœ‰å¼•ç”¨ï¼ˆå°±åƒä¸Šé¢çš„ `john`ï¼‰ï¼Œ ç„¶åå®ƒä¼šè¢«è‡ªåŠ¨å›æ”¶. ä½†æ˜¯åœ¨ä»æŠ€æœ¯çš„è§’åº¦å¹¶ä¸èƒ½å‡†ç¡®çŸ¥é“ *ä½•æ—¶å¼€å§‹æ¸…ç†*ã€‚

è¿™äº›éƒ½ç”± JavaScript å†³å®šã€‚ä¸ºäº†ä¼˜åŒ–å†…å­˜ï¼Œå®ƒå¯èƒ½ä¼šç«‹åˆ»å¼€å§‹æ¸…é™¤æˆ–è€…ç­‰å¾…å¹¶åœ¨ç¨åæ›´å¤šæ¸…ç†çš„æ—¶å€™æ‰å¼€å§‹æ‰§è¡Œæ¸…ç†ã€‚ æ‰€ä»¥, ä»æŠ€æœ¯ä¸Šæ¥è¯´ï¼Œ`WeakMap` çš„å½“å‰æˆå‘˜çš„æ•°é‡æ˜¯æœªçŸ¥çš„ï¼Œå¼•æ“æ—¢æœ‰å¯èƒ½æ¸…ç†åˆå¯èƒ½ä¸æ¸…ç†ï¼Œæˆ–è€…åªæ˜¯æ¸…ç†ä¸€éƒ¨åˆ†ã€‚ ç”±äºè¿™äº›åŸå› ï¼Œæš‚ä¸æ”¯æŒè®¿é—®æ‰€æœ‰é”®æˆ–è€…å€¼çš„æ–¹æ³•ã€‚

é‚£è¿™ç§æ•°æ®ç»“æ„ç”¨åœ¨ä½•å¤„å‘¢ï¼Ÿ

## ä½¿ç”¨æ¡ˆä¾‹: é™„åŠ æ•°æ®

`WeakMap` çš„ä¸»è¦åº”ç”¨é¢†åŸŸæ˜¯ *é™„åŠ æ•°æ®å­˜å‚¨*

å‡å¦‚æˆ‘ä»¬åœ¨å¤„ç†ä¸€ä¸ª â€œå±äºâ€ å…¶å®ƒä»£ç çš„å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯ç¬¬ä¸‰æ–¹åº“ï¼Œæƒ³å­˜å‚¨ä¸€äº›ä¸å…¶ç›¸å…³çš„æ•°æ®ï¼Œè¿™å°±è¦æ±‚ä¸è¿™ä¸ªå¯¹è±¡å…±å­˜äº¡ --- è¿™æ—¶å€™ `WeakMap` å°±æ˜¯æ‰€æˆ‘ä»¬å¤šéœ€è¦çš„åˆ©å™¨

æˆ‘ä»¬åˆ©ç”¨å¯¹è±¡ä½œä¸ºé”®å¹¶æŠŠæ•°æ®å­˜åœ¨åˆ° `WeakMap`ä¸­ï¼Œå½“è¯¥å¯¹è±¡è¢«å›æ”¶æ—¶ï¼Œè¯¥æ•°æ®ä¹Ÿä¼šè‡ªåŠ¨æ¶ˆå¤±ã€‚

```js
weakMap.set(john, "secret documents");
// å¦‚æœ john æ¶ˆå¤±, secret documents å°†ä¼šè¢«è‡ªåŠ¨åˆ é™¤
```

è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰è¿™æ ·çš„ä»£ç éœ€è¦è®°å½•è®¿å®¢çš„æ¥è®¿æ¬¡æ•°ï¼Œä¿¡æ¯è¢«å­˜å‚¨åœ¨å¼±é›†åˆä¸­ï¼šæŸä¸ªç”¨æˆ·å¯¹è±¡ä½œä¸ºé”®ï¼Œæ¥è®¿æ¬¡æ•°ä½œä¸ºå€¼ã€‚å½“æŸä¸ªç”¨æˆ·å‡ºå»äº†ï¼ˆè¯¥å¯¹è±¡è¢«å›æ”¶ï¼‰ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦å†å­˜å‚¨ä»–ä»¬çš„æ¥è®¿æ¬¡æ•°äº†

ä¸‹é¢æœ‰ä¸ªç±»ä¼¼çš„ä½¿ç”¨ `Map` çš„å‡½æ•°:

```js
// ğŸ“ visitsCount.js
let visitsCountMap = new Map(); // map: user => visits count

// é€’å¢æ¸¸å®¢æ¥è®¿æ¬¡æ•°
function countUser(user) {
  let count = visitsCountMap.get(user) || 0;
  visitsCountMap.set(user, count + 1);
}
```
ä¸‹é¢æ˜¯å…¶å®ƒéƒ¨åˆ†çš„ä»£ç , å…¶å®ƒä»£ç ä¹Ÿä½¿ç”¨å®ƒ:

```js
// ğŸ“ main.js
let john = { name: "John" };

countUser(john); // count his visits
countUser(john);

// later john leaves us
john = null;
```

ç°åœ¨ `john` è¿™ä¸ªå¯¹è±¡åº”è¯¥è¢«å›æ”¶ï¼Œä½†å› ä¸ºä»–çš„é”®è¿˜åœ¨`visitsCountMap` ä¸­å¯¼è‡´å®ƒä¾ç„¶ç•™å­˜åœ¨å†…å­˜ä¸­ã€‚

å¯¹æˆ‘ä»¬ç§»é™¤æŸä¸ªç”¨æˆ·çš„æ—¶å€™éœ€è¦æ¸…ç† `visitsCountMap` ï¼Œ å¦åˆ™å®ƒä»¬ä¼šåœ¨å†…å­˜ä¸­æ— é™å¢åŠ ã€‚è¿™ç§æ¸…ç†åœ¨å¤æ‚çš„æ¶æ„ç³»ç»Ÿä¸­å°†ä¼šæ˜¯å¾ˆä¹å‘³çš„ä»»åŠ¡ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ `WeakMap` æ¥é¿å…è¿™æ ·çš„é—®é¢˜ï¼š

```js
// ğŸ“ visitsCount.js
let visitsCountMap = new WeakMap(); // weakmap: user => visits count

// é€’å¢æ¸¸å®¢æ¥è®¿æ¬¡æ•°
function countUser(user) {
  let count = visitsCountMap.get(user) || 0;
  visitsCountMap.set(user, count + 1);
}
```

ç°åœ¨æˆ‘ä»¬ä¸éœ€è¦å»æ¸…ç†`visitsCountMap`äº†ã€‚`WeakMap` é‡Œçš„ `john` å¯¹è±¡ä»¥åŠå®ƒæºå¸¦çš„ä¿¡æ¯å°†ä¼šè¢«å›æ”¶ï¼ˆæ¸…é™¤ï¼‰ï¼Œå…¶å®ƒæ‰€æœ‰é€”å¾„éƒ½ä¸èƒ½è®¿é—®å®ƒé™¤éæ˜¯ä½œä¸º `WeakMap` çš„é”®ã€‚

## ä½¿ç”¨æ¡ˆä¾‹: ç¼“å­˜

å¦å¤–ä¸€ä¸ªå¾ˆæ™®éçš„ä¾‹å­æ˜¯ç¼“å­˜: å½“å‡½æ•°çš„ç»“æœéœ€è¦è¢«è®°ä½ï¼ˆâ€œç¼“å­˜â€ï¼‰ï¼Œè¿™æ ·åœ¨åç»­çš„åŒä¸€ä¸ªå¯¹è±¡è°ƒç”¨çš„æ—¶å€™å¯ä»¥é‡ç”¨è¯¥è¢«ç¼“å­˜çš„ç»“æœã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `Map` æ¥å­˜å‚¨ç»“æœï¼Œå°±åƒè¿™æ ·ï¼š

```js run
// ğŸ“ cache.js
let cache = new Map();

// è®¡ç®—å¹¶è®°ä½ç»“æœ
function process(obj) {
  if (!cache.has(obj)) {
    let result = /* è®¡ç®— obj å€¼çš„ç»“æœ */ obj;

    cache.set(obj, result);
  }

  return cache.get(obj);
}

*!*
// ç°åœ¨æˆ‘ä»¬åœ¨å…¶å®ƒæ–‡ä»¶ä¸­ä½¿ç”¨ process() ï¼š
*/!*

// ğŸ“ main.js
let obj = {/* å‡è®¾æœ‰ä¸ªå¯¹è±¡ */};

let result1 = process(obj); // è®¡ç®—ä¸­...

// ...ä¹‹å, æ¥è‡ªå¦å¤–ä¸€ä¸ªåœ°æ–¹çš„ä»£ç ...
let result2 = process(obj); // remembered result taken from cache

// ...ä¹‹å, æ”¹å¯¹è±¡ä¸å†éœ€è¦ä½¿ç”¨æ—¶:
obj = null;

alert(cache.size); // 1 (å•Š! è¯¥å¯¹è±¡ä¾ç„¶åœ¨ cache ä¸­, å¹¶å æ®ç€å†…å­˜ï¼)
```

å¯¹äºåŒä¸€ä¸ªå¯¹è±¡å¤šæ¬¡è°ƒç”¨ï¼Œå®ƒåªæ˜¯è®¡ç®—ç¬¬ä¸€æ¬¡ï¼Œä¹‹åç›´æ¥ä» `cache` ä¸­è·å–ï¼Œè¿™æ ·åšçš„ç¼ºç‚¹æ˜¯å½“æˆ‘ä»¬ä¸å†éœ€è¦è¿™ä¸ªå¯¹è±¡çš„æ—¶å€™éœ€è¦æ¸…ç† `cache`

å¦‚æœæˆ‘ä»¬ç”¨ `WeakMap` ä»£æ›¿`Map`è¿™ä¸ªé—®é¢˜ä¾¿ä¼šæ¶ˆå¤±ï¼š ç¼“å­˜çš„ç»“æœåœ¨è¯¥å¯¹è±¡èƒŒå›æ”¶ä¹‹åä¼šè‡ªåŠ¨ä»å†…å­˜ä¸­é‡Šæ”¾ã€‚

```js run
// ğŸ“ cache.js
*!*
let cache = new WeakMap();
*/!*

// è®¡ç®—å¹¶è®°ç»“æœ
function process(obj) {
  if (!cache.has(obj)) {
    let result = /* è®¡ç®— obj ä¹‹åå¾—å‡ºçš„ç»“æœ */ obj;

    cache.set(obj, result);
  }

  return cache.get(obj);
}

// ğŸ“ main.js
let obj = {/* some object */};

let result1 = process(obj);
let result2 = process(obj);

// ...ä¹‹å, å½“è¯¥å¯¹è±¡ä¸å†éœ€è¦çš„æ—¶å€™:
obj = null;

// ä¸èƒ½ä½¿ç”¨ cache.size, å› ä¸ºå®ƒæ˜¯ä¸€ä¸ª WeakMap,
// è¦ä¹ˆæ˜¯ 0 æˆ–è€… å¾ˆå¿«å˜æˆ 0
// å½“ obj è¢«å›æ”¶æ—¶, ç¼“å­˜çš„æ•°æ®ä¹Ÿä¼šè¢«æ¸…é™¤
```

## WeakSet

`WeakSet` çš„ä½œç”¨ç±»ä¼¼:

- å®ƒè·Ÿ `Set` ç±»ä¼¼, ä½†æ˜¯æˆ‘ä»¬åªèƒ½æ·»åŠ å¯¹è±¡åˆ° `WeakSet` (éåŸå§‹å€¼)ä¸­ã€‚
- æŸä¸ªå¯¹è±¡åªæœ‰åœ¨å…¶å®ƒä»»ä½•åœ°æ–¹éƒ½èƒ½è®¿é—®çš„æ—¶å€™æ‰èƒ½ç•™åœ¨ set é‡Œã€‚
- è·Ÿ `Set` ä¸€æ ·, `WeakSet` æ”¯æŒ `add`, `has` and `delete` ç­‰æ–¹æ³•, ä½†ä¸æ”¯æŒ `size`, `keys()` å¹¶ä¸”æ²¡æœ‰è¿­ä»£ã€‚
å˜ "å¼±" çš„åŒæ—¶, å®ƒä¹Ÿå¯ä»¥ä½œä¸ºé¢å¤–çš„å­˜å‚¨ç©ºé—´ï¼Œä½†å¹¶éä»»æ„æ•°æ®ï¼Œè€Œæ˜¯é’ˆå¯¹â€œæ˜¯/å¦â€çš„äº‹å®ï¼Œåœ¨ `WeakSet` é‡Œçš„æˆå‘˜ä»£è¡¨ç€å¯¹è±¡é‡Œçš„æŸä¸ªå±æ€§ã€‚
ä¾‹å¦‚, æˆ‘ä»¬å¯ä»¥æ·»åŠ  users åˆ° `WeakSet` é‡Œæ¥è¿½è¸ªè°è®¿é—®äº†æˆ‘ä»¬çš„ç½‘ç«™ï¼š

```js run
let visitedSet = new WeakSet();

let john = { name: "John" };
let pete = { name: "Pete" };
let mary = { name: "Mary" };

visitedSet.add(john); // John visited us
visitedSet.add(pete); // Then Pete
visitedSet.add(john); // John again

// ç°åœ¨ visitedSet æœ‰2ä¸ªç”¨æˆ·

// æ£€æŸ¥ John æ˜¯å¦è®¿é—®è¿‡?
alert(visitedSet.has(john)); // true

// æ£€æŸ¥ Mary æ˜¯å¦è®¿é—®è¿‡?
alert(visitedSet.has(mary)); // false

john = null;

// visitedSet å°†è¢«è‡ªåŠ¨æ¸…ç†
```

 `WeakMap` å’Œ `WeakSet` æœ€å‡ºåçš„é™åˆ¶æ˜¯ä¸èƒ½è¿­ä»£ï¼Œè·å–å¤šæœ‰çš„å½“å‰å†…å®¹ã€‚é‚£æ ·å¯èƒ½ä¼šé€ æˆä¸ä¾¿ï¼Œä½†æ˜¯ä¾æ—§ä¸èƒ½é˜»æ­¢ `WeakMap/WeakSet` åšå¾ˆé‡è¦çš„äº‹æƒ… -- æˆä¸ºåœ¨å…¶å®ƒåœ°æ–¹ç®¡ç†æˆ–è€…å­˜å‚¨çš„å¯¹è±¡ â€œé¢å¤–çš„â€ å­˜å‚¨æ•°æ®

## æ€»ç»“

` WeakMap` æ˜¯ç±»ä¼¼äº `Map` çš„é›†åˆï¼Œå®ƒä»…å…è®¸å¯¹è±¡ä½œä¸ºé”®ï¼Œå¹¶åœ¨å…¶ä»–æ–¹å¼æ— æ³•è®¿é—®å®ƒä»¬æ—¶å°†å…¶ä¸å…³è”å€¼ä¸€èµ·åˆ é™¤ã€‚

`WeakSet` æ˜¯ç±»ä¼¼äº`Set`çš„é›†åˆï¼Œå®ƒä»…å­˜å‚¨å¯¹è±¡ï¼Œå¹¶åœ¨å…¶ä»–æ–¹å¼æ— æ³•è®¿é—®å®ƒä»¬æ—¶å°†å…¶åˆ é™¤ã€‚ 

å®ƒä»¬éƒ½ä¸æ”¯æŒå¼•ç”¨æ‰€æœ‰é”®æˆ–å…¶è®¡æ•°çš„æ–¹æ³•å’Œå±æ€§ã€‚ ä»…å…è®¸å•ä¸ªæ“ä½œã€‚

`WeakMap` å’Œ`WeakSet`è¿˜ç”¨ä½œâ€œè¾…åŠ©â€æ•°æ®ç»“æ„ã€‚ ä¸€æ—¦å°†å¯¹è±¡ä»ä¸»å­˜å‚¨å™¨ä¸­åˆ é™¤ï¼Œå¦‚æœä»…å°†å…¶ä½œä¸ºâ€œ WeakMapâ€æˆ–â€œ WeakSetâ€çš„é”®ï¼Œé‚£ä¹ˆåˆ™å°†è‡ªåŠ¨æ¸…é™¤è¯¥å¯¹è±¡ã€‚
