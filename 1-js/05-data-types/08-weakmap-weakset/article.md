# WeakMap å’Œ WeakSet

ä»[åƒåœ¾å›æ”¶æœºåˆ¶](https://zh.javascript.info/garbage-collection)è¿™ä¸€ç« èŠ‚ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒJavaScript å¼•æ“ä¼šæŠŠå¯ç”¨ï¼ˆå¯èƒ½ä¼šè¢«ç”¨ï¼‰çš„å€¼å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚

ä¾‹å¦‚ï¼š
```js run
let john = { name: "John" };

// å¯¹è±¡å¯ä»¥è¢«è®¿é—®, john æ˜¯è¯¥å¯¹è±¡çš„å¼•ç”¨

// è¦†ç›–å¼•ç”¨
john = null;

// è¯¥å¯¹è±¡å°†ä¼šä»å†…å­˜ä¸­ç§»é™¤
```

é€šå¸¸ï¼Œå¯¹è±¡çš„å±æ€§æˆ–è€…æ•°ç»„å…ƒç´ æˆ–è€…å…¶ä»–æ•°æ®ç»“æ„åœ¨è¢«è®¤ä¸ºå¯ç”¨çš„çš„æƒ…å†µä¸‹ä¼šè¢«ä¸€ç›´ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œè€Œè¯¥æ•°æ®ç»“æ„åœ¨å†…å­˜ä¸­ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æŠŠä¸€ä¸ªå¯¹è±¡æ”¾å…¥ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œå½“è¯¥æ•°ç»„å­˜åœ¨ï¼Œå³ä½¿æŠŠè¯¥å¯¹è±¡çš„å¼•ç”¨è¦†ç›–äº†ï¼Œè¯¥å¯¹è±¡ä¹Ÿä¼šå­˜åœ¨ã€‚

åƒè¿™æ ·ï¼š

```js run
let john = { name: "John" };

let array = [ john ];

john = null; // è¦†ç›–å¼•ç”¨

// john è¢«å­˜å‚¨åœ¨æ•°ç»„ä¸­, æ‰€ä»¥å®ƒä¸ä¼šè¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶
// æˆ‘ä»¬å¯ä»¥è¿™æ ·è®¿é—®å®ƒ array[0]
```
ç±»ä¼¼åœ°ï¼Œå¦‚æœæˆ‘ä»¬æŠŠä¸€ä¸ªå¯¹è±¡ä½œä¸ºå¸¸è§„ `Map` çš„é”®ï¼Œç„¶åå½“ `Map` å­˜åœ¨æ—¶ï¼Œè¯¥å¯¹è±¡ä¹Ÿä¼šå­˜åœ¨ã€‚å®ƒå¯èƒ½ä¸ä¼šè¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶å¹¶ä¸”å æ®ç€å†…å­˜

ä¾‹å¦‚ï¼š

```js run
let john = { name: "John" };

let map = new Map();
map.set(john, "...");

john = null; // è¦†ç›–å¼•ç”¨

// john è¢«å­˜å‚¨åœ¨ map çš„å†…éƒ¨,
// æˆ‘ä»¬å¯ä»¥è¿™æ ·è®¿é—®å®ƒï¼š map.keys()
```
 `WeakMap` åœ¨è¿™æ–¹é¢æœ‰å¾ˆå¤§ä¸åŒï¼Œå®ƒä¸ä¼šé˜»æ­¢åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶é‡è¦çš„å¯¹è±¡

è®©æˆ‘ä»¬é€šè¿‡ä¾‹å­æ¥çœ‹çœ‹ç€æ„å‘³ç€ä»€ä¹ˆ

## WeakMap

å’Œ `Map` çš„ç¬¬ä¸€ä¸ªä¸åŒç‚¹å°±æ˜¯ `WeakMap` çš„é”®å¿…é¡»æ˜¯å¯¹è±¡ï¼Œä¸èƒ½è¯•åŸå§‹å€¼ï¼š

```js run
let weakMap = new WeakMap();

let obj = {};

weakMap.set(obj, "ok"); // æ­£å¸¸æ‰§è¡Œ (ä»¥å¯¹è±¡ä½œä¸ºé”®)

// ä¸èƒ½ä½¿ç”¨å­—ç¬¦ä¸²ä½œä¸ºé”®
weakMap.set("test", "Whoops"); // é”™è¯¯ï¼Œå› ä¸º "test" ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡
```

ç°åœ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡ä½œä¸ºé”®å€¼æ”¾å…¥å…¶ä¸­ï¼Œå¦‚æœæ²¡æœ‰å…¶å®ƒå¼•ç”¨åœ¨è¯¥å¯¹è±¡ä¸Š-å®ƒå°±ä¼šä»å†…å­˜ä¸­ï¼ˆå’Œæ¥è‡ªé›†åˆé‡Œé¢ï¼‰è¢«è‡ªåŠ¨ç§»é™¤

```js run
let john = { name: "John" };

let weakMap = new WeakMap();
weakMap.set(john, "...");

john = null; // è¦†ç›–å¼•ç”¨

// john åœ¨å†…å­˜ä¸­è¢«ç§»é™¤!
```

æ¯”è¾ƒä¸€ä¸‹ä»¥ä¸Šä¾‹å­ä¸­çš„å¸¸è§„ `Map` ï¼Œç°åœ¨å¦‚æœ `john` ä»…ä»…æ˜¯ä½œä¸º `WeakMap` çš„é”®å­˜åœ¨æ—¶ - ä»–å°†ä¼šä»é›†åˆä¸­ï¼ˆå’Œå†…å­˜ï¼‰è¢«è‡ªåŠ¨åˆ é™¤ã€‚

`WeakMap` ä¸æ”¯æŒè¿­ä»£å’Œ `keys()`, `values()`,`entries()` æ–¹æ³•ã€‚æ‰€ä»¥æ²¡æœ‰åŠæ³•ä»å®ƒé‡Œé¢è·å–æ‰€æœ‰çš„é”®æˆ–è€…å€¼ã€‚

`WeakMap` ä»…ä»…åªæœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š

- `weakMap.get(key)`
- `weakMap.set(key, value)`
- `weakMap.delete(key)`
- `weakMap.has(key)`

ä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„é™åˆ¶å‘¢ï¼Ÿé‚£æ˜¯å‡ºäºæŠ€æœ¯åŸå› ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡å·²ç»å¤±å»æ‰€æœ‰å…¶ä»–çš„å¼•ç”¨ï¼ˆå°±åƒä¸Šé¢çš„ `john` ä¸€æ ·ï¼‰ï¼Œç„¶åå®ƒä¼šè¢«åƒåœ¾å›æ”¶æœºåˆ¶è‡ªåŠ¨å›æ”¶ã€‚ä½†æ˜¯ä»æŠ€æœ¯ä¸Šæ¥è¯´å¹¶ä¸èƒ½ç¡®å®šæ¸…ç†ä¼šåœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿã€‚

ä»¥ä¸Šç”± JavaScript å¼•æ“å†³å®šã€‚å®ƒå¯èƒ½ä¼šé€‰æ‹©ç«‹å³æ¸…ç†æ¥ä¼˜åŒ–å†…å­˜æˆ–è€…ç­‰å¾…å’Œå‘ç”Ÿæ›´å¤šçš„åˆ é™¤æ—¶æ‰æ¸…ç†ã€‚æ‰€ä»¥ï¼Œä»æŠ€æœ¯ä¸Šï¼Œå¹¶ä¸èƒ½çŸ¥é“ä¸€ä¸ª `WeakMap` çš„å½“å‰å…ƒç´ çš„ä¸ªæ•°ã€‚å¼•æ“å¯èƒ½ä¼šæ¸…ç†æ‰å®ƒä¹Ÿå¯èƒ½ä¸ä¼šï¼Œæˆ–è€…æ¸…ç†æ‰ä¸€éƒ¨åˆ†ã€‚ç”±äºè¿™ä¸ªåŸå› ï¼Œè®¿é—®æ‰€æœ‰é”®/å€¼çš„æ–¹æ³•ä¸èƒ½è¢«æ”¯æŒã€‚

ç°åœ¨æˆ‘ä»¬åœ¨å“ªé‡Œä¼šéœ€è¦è¿™æ ·çš„æ•°æ®ç»“æ„å‘¢ï¼Ÿ

## ä½¿ç”¨æ¡ˆä¾‹ï¼š é™„åŠ æ•°æ®

`WeakMap` çš„ä¸»è¦åº”ç”¨é¢†åŸŸæ˜¯åœ¨ä¸€ç§é™„åŠ æ•°æ®å­˜å‚¨

å¦‚æœæˆ‘ä»¬åœ¨å¤„ç†ä¸€ä¸ªâ€œå±äºâ€å…¶å®ƒä»£ç çš„å¯¹è±¡ï¼Œç”šè‡³å¯èƒ½æ˜¯ç¬¬ä¸‰æ–¹åº“ï¼Œå°±æœ‰å¯èƒ½å‚¨å­˜ä¸€äº›ç›¸å…³è”çš„æ•°æ®ï¼Œå®ƒä»…ä»…åœ¨è¯¥å¯¹è±¡å­˜åœ¨æ—¶æ‰å­˜åœ¨ - `WeakMap`å°±æ˜¯æˆ‘ä»¬çœŸæ­£éœ€è¦çš„ç»“æ„ã€‚

æˆ‘ä»¬æŠŠæŸäº›æ•°æ®æ”¾å…¥åˆ° `WeakMap` ä¸­ï¼Œå¹¶ä½¿ç”¨å¯¹è±¡ä½œä¸ºé”®ï¼Œå½“è¯¥å¯¹è±¡è¢«å›æ”¶æ—¶ï¼Œæ”¹æ•°æ®ä¹Ÿä¼šè‡ªåŠ¨æ¶ˆå¤±ã€‚

```js run
weakMap.set(john, "secret documents");
// å¦‚æœ john ä¸å­˜åœ¨äº†, secret documents ä¹Ÿä¼šè‡ªåŠ¨é”€æ¯
```

è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚

æ¯”å¦‚ï¼Œæˆ‘ä»¬æœ‰ä¸€æ®µä»£ç ä¸»è¦è®°å½•ç”¨æˆ·è®¿é—®çš„æ¬¡æ•°ã€‚è¯¥ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªmapç»“æ„ä¸­ï¼šç”¨æˆ·å¯¹è±¡ä½œä¸ºé”®ï¼Œæ¬¡æ•°ä½œä¸ºå€¼ã€‚å½“ç”¨æˆ·ç¦»å¼€ï¼ˆä¹Ÿå°±æ˜¯ä»–çš„å¯¹è±¡è¢«å›æ”¶ï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿä¸éœ€è¦å†å­˜å‚¨è®¿é—®æ¬¡æ•°äº†ã€‚

è¿™é‡Œæœ‰ä¸ªä½¿ç”¨ `Map` æ¥è®¡ç®—çš„å‡½æ•°:

```js run
// ğŸ“ visitsCount.js
let visitsCountMap = new Map(); // map: user => è®¿é—®æ¬¡æ•°

// å¢åŠ è®¿é—®æ¬¡æ•°
function countUser(user) {
  let count = visitsCountMap.get(user) || 0;
  visitsCountMap.set(user, count + 1);
}
```
ç„¶åè¿™é‡Œæ˜¯ä»£ç çš„å¦å¤–ä¸€éƒ¨åˆ†ï¼Œå…¶å®ƒæ–‡ä»¶å¯èƒ½ä¼šä½¿ç”¨å®ƒï¼š

```js run
// ğŸ“ main.js
let john = { name: "John" };

countUser(john); // è®¡ç®—ä»–çš„è®¿é—®æ¬¡æ•°
countUser(john);

// ç„¶å john ç¦»å¼€æˆ‘ä»¬
john = null;

```

ç°åœ¨ `john` å¯¹è±¡åº”è¯¥è¢«å›æ”¶ï¼Œä½†æ˜¯å®ƒè¿˜ç•™åœ¨äº†å†…å­˜ä¸­ï¼Œå› ä¸ºå®ƒè¢«ä½œä¸ºäº† `visitsCountMap` çš„é”®ã€‚

å½“ç§»é™¤ç”¨æˆ·çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ¸…ç† `visitsCountMap`ï¼Œå¦åˆ™å®ƒå°†ä¼šåœ¨å†…å­˜ä¸­æ— é™å¢åŠ ã€‚ è¿™æ ·çš„æ¸…ç†åœ¨å¤æ‚çš„æ¶æ„ä¸­ä¼šå˜æˆå†—ä½™çš„ä»»åŠ¡ã€‚

æˆ‘ä»¬é€šè¿‡åˆ‡æ¢æˆ `WeakMap` æ¥æ›¿ä»£å®ƒä»è€Œé¿å…ä¸Šé¢æåˆ°çš„é—®é¢˜:

```js run
// ğŸ“ visitsCount.js
let visitsCountMap = new WeakMap(); // weakmap: user => è®¿é—®æ¬¡æ•°

// å¢åŠ è®¿é—®æ¬¡æ•°
function countUser(user) {
  let count = visitsCountMap.get(user) || 0;
  visitsCountMap.set(user, count + 1);
}
```

ç°åœ¨æˆ‘ä»¬ä¸å¿…å»æ¸…ç† `visitsCountMap` äº†ï¼Œåœ¨é™¤äº†ä½œä¸º `WeakMap` çš„é”®ä¹‹å¤–ï¼Œ `john` å¯¹è±¡ä¹‹åå°†ä¸èƒ½è¢«å…¶å®ƒæ‰€æœ‰é€”å¾„ä½¿ç”¨

## ä½¿ç”¨æ¡ˆä¾‹ï¼š ç¼“å­˜

å…¶å®ƒå¾ˆå¸¸ç”¨çš„ä¾‹å­å°±æ˜¯ç¼“å­˜ï¼š å½“ä¸€ä¸ªå‡½æ•°ç»“æœåº”è¯¥è¢«è®°ä½ï¼ˆâ€œç¼“å­˜â€ï¼‰çš„æ—¶å€™ï¼Œæ‰€ä»¥å°†æ¥è°ƒç”¨åŒä¸€ä¸ªå¯¹è±¡é‡ç”¨å®ƒã€‚

æˆ‘ä»¬ä½¿ç”¨ `Map` æ¥å­˜å‚¨ç»“æœï¼Œåƒè¿™æ ·ï¼š

```js run
// ğŸ“ cache.js
let cache = new Map();

// è®¡ç®—å¹¶è®°ä½ç»“æœ
function process(obj) {
  if (!cache.has(obj)) {
    let result = /* ç»“æœçš„è®¡ç®— */ obj;

    cache.set(obj, result);
  }

  return cache.get(obj);
}

// ç°åœ¨ä½¿ç”¨å…¶å®ƒæ–‡ä»¶çš„ process() æ–¹æ³•:

// ğŸ“ main.js
let obj = {/* è®©æˆ‘ä»¬æ¥å®šä¹‰ä¸€ä¸ªå¯¹è±¡ */};

let result1 = process(obj); // è¢«è®¡ç®—

// ...ä¹‹å, æ¥è‡ªå…¶å®ƒåœ°æ–¹çš„ä»£ç å—...
let result2 = process(obj); // ä»ç¼“å­˜ä¸­æ‹¿åˆ°è®°ä½çš„ç»“æœ

// ...ä¹‹å, å½“è¿™ä¸ªå¯¹è±¡ä¸å†è¢«éœ€è¦çš„æ—¶å€™:
obj = null;

alert(cache.size); // 1 (å“‡! è¿™ä¸ªå¯¹è±¡ä¾ç„¶åœ¨ç¼“å­˜ä¸­, å æ®å†…å­˜!)
```

å¯¹äºç›¸åŒå¯¹è±¡å¤šæ¬¡è°ƒç”¨ `process(obj)` æ–¹æ³•ï¼Œä»–åªè®¡ç®—ç¬¬ä¸€æ¬¡ï¼Œä¹‹åæ˜¯ä»ç¼“å­˜è·å–ã€‚è¿™æ ·çš„ç¼ºç‚¹å°±æ˜¯å½“è¯¥å¯¹è±¡ä¸åœ¨éœ€è¦çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ¸…ç† `clean` 

å¦‚æœæˆ‘ä»¬ä½¿ç”¨ `WeakMap` æ¥ä»£æ›¿ `Map` ï¼Œç„¶åè¿™äº›é—®é¢˜å°±ä¼šæ¶ˆå¤±ï¼šå½“è¯¥å¯¹è±¡è¢«å›æ”¶æ—¶ï¼Œç¼“å­˜çš„ç»“æœå°†ä¼šä»å†…å­˜ä¸­è‡ªåŠ¨è¢«ç§»é™¤

```js run

// ğŸ“ cache.js
let cache = new WeakMap();

// calculate and remember the result
function process(obj) {
  if (!cache.has(obj)) {
    let result = /* calculate the result for */ obj;

    cache.set(obj, result);
  }

  return cache.get(obj);
}

// ğŸ“ main.js
let obj = {/* some object */};

let result1 = process(obj);
let result2 = process(obj);

// ...later, when the object is not needed any more:
obj = null;

// Can't get cache.size, as it's a WeakMap,
// but it's 0 or soon be 0
// When obj gets garbage collected, cached data will be removed as well

```
## WeakSet

`WeakSet` çš„è¡¨ç°ä¹Ÿç›¸ä¼¼ï¼š

- å®ƒç±»ä¼¼äº `Set` ï¼Œä½†æ˜¯æˆ‘ä»¬ä»…ä»…æ·»åŠ å¯¹è±¡åˆ° `WeakSet` é‡Œ(è€Œä¸æ˜¯åŸå§‹å€¼)

- é›†åˆé‡Œé¢å­˜åœ¨è¯¥å¯¹è±¡å½“å®ƒå¯ä»¥ä»å…¶ä»–åœ°æ–¹è·å–

-è·Ÿ `Set` ä¸€æ ·ï¼Œ`WeakSet` ä¹Ÿæ”¯æŒ `add`, `has` , `delete` æ–¹æ³•ï¼Œä½†æ˜¯ä¸æ”¯æŒ `size`,`key()` å’Œè¿­ä»£

å˜â€œå¼±â€çš„åŒæ—¶ï¼Œå®ƒä¹Ÿè¢«ç”¨ä½œé™„åŠ å­˜å‚¨ã€‚ä½†æ˜¯ä¸é€‚åˆä»»æ„æ•°æ®ï¼Œè€Œæ˜¯å› ä¸ºâ€œæ˜¯ / å¦â€çš„åŸå› .ä¸€ä¸ª `WeakSet` çš„æˆå‘˜å¯èƒ½æ„å‘³ç€å¯¹è±¡çš„å…¶å®ƒ

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ç”¨æˆ·åˆ° `WeakSet` æ¥è¿½è¸ªè°è®¿é—®äº†æˆ‘ä»¬çš„ç½‘ç«™ï¼š

```js run
let visitedSet = new WeakSet();

let john = { name: "John" };
let pete = { name: "Pete" };
let mary = { name: "Mary" };

visitedSet.add(john); // John visited us
visitedSet.add(pete); // Then Pete
visitedSet.add(john); // John again

// visitedSet ç°åœ¨æœ‰2ä¸ªç”¨æˆ·

//  æ£€æŸ¥ John æ˜¯å¦è®¿é—®è¿‡?
alert(visitedSet.has(john)); // true

// æ£€æŸ¥ Mary æ˜¯å¦è®¿é—®è¿‡?
alert(visitedSet.has(mary)); // false

john = null;

// visitedSet å°†ä¼šè¢«è‡ªåŠ¨æ¸…é™¤
```

`WeakMap ` å’Œ `WeakSet`æœ€æ˜¾è‘—çš„é™åˆ¶å°±æ˜¯ç¼ºä¹è¿­ä»£ï¼Œå¹¶ä¸”ä¸èƒ½è·å–å½“å‰æ‰€æœ‰çš„å†…å®¹ã€‚è¿™å¯èƒ½ä¼šé€ æˆå¾ˆå¤§çš„ä¸ä¾¿ï¼Œä½†æ˜¯è¿™å¹¶ä¸ä¼šé˜»æ­¢ `WeakMap/WeakSet` åšä¸»è¦çš„äº‹æƒ…-åœ¨å¦ä¸€ä¸ªåœ°æ–¹å­˜å‚¨/ç®¡ç†çš„å¯¹è±¡çš„â€œé™„åŠ â€å­˜å‚¨æ•°æ®ã€‚

## æ€»ç»“

`WeakMap` æ˜¯ä¸ªç±»ä¼¼äº `Map` çš„åªå…è®¸å¯¹è±¡ä½œä¸ºé”®å’Œé€šè¿‡å…¶å®ƒé€”å¾„ä½¿å¯¹è±¡å˜æˆä¸å¯ç”¨çš„æ—¶å€™å°±ä¼šé©¬ä¸Šç§»é™¤æ‰€æœ‰å…³è”çš„é”®çš„é›†åˆ

`WeakSet` æ˜¯ä¸ªç±»ä¼¼äº `Set` çš„åªå­˜å‚¨å¯¹è±¡å’Œç§»é™¤ä¸€æ—¦é€šè¿‡å…¶å®ƒé€”å¾„ä½¿å…¶å˜å¾—ä¸å¯ç”¨çš„å¯¹è±¡

å®ƒä»¬ä¿©ä¸ªéƒ½ä¸æ”¯æŒè·å–æ‰€æœ‰é”®å’Œå€¼å¾—æ–¹æ³•æˆ–è€…å±æ€§ï¼Œåªå…è®¸ä¸ªåˆ«æ“ä½œã€‚

`WeakMap` å’Œ `WeakSet` è¢«ç”¨è®¤ä¸ºæ˜¯é™¤äº†â€ä¸»è¦â€œå¯¹è±¡å­˜å‚¨ä¹‹å¤–çš„â€œç¬¬äºŒâ€æ•°æ®ç»“æ„ï¼Œä¸€æ—¦å¯¹è±¡åœ¨ä¸»è¦å­˜å‚¨ä¸­è¢«ç§»é™¤ï¼Œå¦‚æœè¯¥å¯¹è±¡ä»…ä»…æ˜¯å­˜å‚¨ä¸º `WeakMap` æˆ–è€… `WeakSet` çš„é”®çš„æ—¶å€™ï¼Œå®ƒå°±ä¼šè¢«è‡ªåŠ¨æ¸…ç†ã€‚
