
# Mapã€Setã€WeakMap å’Œ WeakSet

## Mapã€Set

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ äº†ä¸‹é¢çš„æ¯”è¾ƒå¤æ‚çš„æ•°æ®ç»“æ„ï¼š

- å¯¹è±¡ï¼šå­˜å‚¨é”®å€¼å¯¹çš„é›†åˆã€‚
- æ•°ç»„ï¼šå­˜å‚¨æœ‰åºé›†åˆã€‚

ä½†æ˜¯ï¼Œå®é™…åº”ç”¨æ—¶è¿˜æ˜¯ä¸å¤Ÿã€‚è¿™å°±æ˜¯ `Map` å’Œ `Set` å­˜åœ¨çš„åŸå› ã€‚

## Map

[Map](mdn:js/Map) æ˜¯ä¸€ä¸ªé”®å€¼å¯¹çš„é›†åˆï¼Œå¾ˆåƒ `Object`ã€‚ä½†ä¸»è¦çš„åŒºåˆ«æ˜¯ï¼Œ`Map` å…è®¸æ‰€æœ‰æ•°æ®ç±»å‹ä½œä¸ºé”®ã€‚

ä¸»è¦çš„æ–¹æ³•åŒ…æ‹¬ï¼š

- `new Map()` -- åˆ›å»º mapã€‚
- `map.set(key, value)` -- æ ¹æ®é”®ï¼ˆkeyï¼‰å­˜å‚¨å€¼ï¼ˆvalueï¼‰ã€‚
- `map.get(key)` -- æ ¹æ®é”®è¿”å›å€¼ï¼Œå¦‚æœ map ä¸­è¯¥é”®ä¸å­˜åœ¨ï¼Œè¿”å› `undefined`ã€‚
- `map.has(key)` -- å¦‚æœé”®å­˜åœ¨ï¼Œè¿”å› `true`ï¼Œå¦åˆ™è¿”å› `false`ã€‚
- `map.delete(key)` -- ç§»é™¤è¯¥é”®çš„å€¼ã€‚
- `map.clear()` -- æ¸…ç©º map
- `map.size` -- è¿”å›å½“å‰å…ƒç´ ä¸ªæ•°ã€‚

ä¾‹å¦‚ï¼š

```js run
let map = new Map();

map.set('1', 'str1');   // å­—ç¬¦ä¸²ä½œä¸º key
map.set(1, 'num1');     // æ•°å­—ä½œä¸º key
map.set(true, 'bool1'); // å¸ƒå°”å€¼ä½œä¸º key

// è¿˜è®°å¾—æ™®é€šå¯¹è±¡ Object å—ï¼Ÿå®ƒå°†ä¼šæŠŠæ‰€æœ‰çš„é”®è½¬åŒ–ä¸ºå­—ç¬¦ä¸²ç±»å‹
// ä½†æ˜¯ Map å°†ä¼šä¿ç•™é”®çš„ç±»å‹ï¼Œæ‰€ä»¥ä¸‹é¢è¿™ä¸¤ä¸ªæ˜¯ä¸åŒçš„ï¼š
alert( map.get(1)   ); // 'num1'
alert( map.get('1') ); // 'str1'

alert( map.size ); // 3
```

æ­£å¦‚æˆ‘ä»¬æ‰€è§ï¼Œä¸åƒæ™®é€šå¯¹è±¡ï¼Œé”®å¹¶æ²¡æœ‰è¢«è½¬åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚ä»»ä½•ç±»å‹çš„é”®éƒ½æ˜¯å¯ä»¥çš„ã€‚

**Map å¯ä»¥ä½¿ç”¨å¯¹è±¡ä½œä¸ºé”®ã€‚**

ä¾‹å¦‚ï¼š
```js run
let john = { name: "John" };

// å­˜ä¸‹æ¯ä¸ªç”¨æˆ·çš„æ¥è®¿æ¬¡æ•°
let visitsCountMap = new Map();

// john æ˜¯ map çš„é”®
visitsCountMap.set(john, 123);

alert( visitsCountMap.get(john) ); // 123
```

ä½¿ç”¨å¯¹è±¡ä½œä¸ºé”®æ˜¯ `Map` æœ€è‘—åå’Œé‡è¦çš„ç‰¹æ€§ã€‚å¯¹äºå­—ç¬¦ä¸²é”®ï¼Œ `Onbject` å¯èƒ½ä¼šå¾ˆå‹å¥½ï¼Œä½†æ˜¯ä¸èƒ½ä½¿ç”¨å¯¹è±¡ä½œä¸ºé”®

æˆ‘ä»¬æ¥è¯•ä¸€ä¸‹ï¼š

```js run
let john = { name: "John" };

let visitsCountObj = {}; // å°è¯•ä½¿ç”¨æ™®é€šå¯¹è±¡

visitsCountObj[john] = 123; // å°è¯•æŠŠ john ä½œä¸ºé”®

// That's what got written!
alert( visitsCountObj["[object Object]"] ); // 123
```

å½“ `visitsCountObj` æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡æ—¶ï¼Œå®ƒä¼šè½¬åŒ–æ‰€æœ‰çš„é”®ï¼Œæƒ³ `john` ä¼šå˜æˆå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå¾—åˆ°çš„ `[object Object]` ç»“æœ,å¾ˆæ˜æ˜¾è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœ

````

```smart header="How `Map` compares keys"
ä¸ºäº†æ£€æµ‹å€¼æ˜¯å¦ç›¸ç­‰ï¼Œ`Map` ä½¿ç”¨äº†ç®—æ³• [SameValueZero](https://tc39.github.io/ecma262/#sec-samevaluezero)ã€‚å®ƒå¤§æ¦‚å°±å’Œä¸¥æ ¼ç­‰äºå· `===` ç›¸åŒï¼Œä½†åŒºåˆ«æ˜¯ `NaN` ç­‰äº `NaN`ã€‚æ‰€ä»¥ `NaN` ä¹Ÿå¯ä»¥ä½œä¸ºé”®ã€‚

è¯¥ç®—æ³•ä¸èƒ½æ›´æ”¹æˆ–ç”¨æˆ·å®šåˆ¶ã€‚
```


````smart header="Chaining"

æ¯æ¬¡ `map.set` çš„è°ƒç”¨å°†ä¼šè¿”å› map è‡ªèº«ï¼Œæ‰€ä»¥å¯ä»¥é“¾å¼è°ƒç”¨ï¼š

```js
map.set('1', 'str1')
  .set(1, 'num1')
  .set(true, 'bool1');
```
````
## `Map` ä¸Šçš„è¿­ä»£

è¦å¾ªç¯ä¸€ä¸ª `Map` ï¼Œè¿™é‡Œæœ‰3ä¸ªæ–¹æ³•ï¼š

- `map.keys()` -- è¿”å›ä¸€ä¸ªå¯è¿­ä»£çš„é”®é›†åˆ

- `map.values()` -- è¿”å›ä¸€ä¸ªå¯è¿­ä»£çš„å€¼é›†åˆ

- `map.entires()` -- è¿”å›ä¸€ä¸ªå¯è¿­ä»£çš„é”®å€¼å¯¹é›†åˆ `[key, value]`,é»˜è®¤ä½¿ç”¨ `for..of`

ä¾‹å¦‚ï¼š

```js run
let recipeMap = new Map([
  ['cucumber', 500],
  ['tomatoes', 350],
  ['onion',    50]
]);

// iterate over keys (vegetables)
for (let vegetable of recipeMap.keys()) {
  alert(vegetable); // cucumber, tomatoes, onion
}

// iterate over values (amounts)
for (let amount of recipeMap.values()) {
  alert(amount); // 500, 350, 50
}

// iterate over [key, value] entries
for (let entry of recipeMap) { // the same as of recipeMap.entries()
  alert(entry); // cucumber,500 (and so on)
}

```
```text
ä½¿ç”¨æ’å…¥é¡ºåº

å½“æ–°å€¼è¢«æ’å…¥æ—¶è¿­ä»£ä¼šä½¿ç”¨ç›¸åŒçš„é¡ºåºï¼Œ `Map`ä¼šä¿ç•™è¿™ä¸ªé¡ºåºï¼Œ ä¸åƒå¸¸è§„ `Object`

```

å¦å¤–ï¼Œ`Map` ä¹Ÿæœ‰å†…ç½®æ–¹æ³• `forEach` ï¼Œè·Ÿ `Array` ç›¸åŒ:

```js run
// è¿è¡Œfor each å‡½æ•°ï¼Œä½œç”¨äºé”®å€¼å¯¹
recipeMap.forEach( (value, key, map) => {
  alert(`${key}: ${value}`); // é»„ç“œ: 500   ç­‰ç­‰
});

```

##Object.entries:Object è½¬æˆ Map 

å½“ `Map`è¢«åˆ›å»ºæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ é€’ä¸€ä¸ªæ•°ç»„ï¼ˆå…¶å®ƒä»»ä½•å¯è¿­ä»£çš„ï¼‰å……å½“é”®å€¼å¯¹æ¥åˆå§‹åŒ–ï¼Œåƒè¿™æ ·ï¼š

```js run
// æ•°ç»„é”®å€¼å¯¹
let map = new Map([
  ['1',  'str1'],
  [1,    'num1'],
  [true, 'bool1']
]);

alert( map.get('1') ); // str1
```

å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œå¹¶ä¸”æˆ‘ä»¬æƒ³åˆ©ç”¨è¯¥å¯¹è±¡åˆ›å»ºä¸€ä¸ª `Map`ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å†…å»ºæ–¹æ³• [Object.entries(obj)](mdn:js/Map) è¿”å›ä¸€ä¸ªæ•°ç»„åŒ…å«å·²ç»æ ¼å¼åŒ–çš„å¯¹è±¡é”®å€¼å¯¹ã€‚

æ‰€ä»¥æˆ‘ä»¬åƒä¸‹é¢è¿™æ ·é€šè¿‡å¯¹è±¡æ¥åˆ›å»ºä¸€ä¸ª map :

```js run 
let obj = {
  name: "John",
  age: 30
};

let map = new Map(Object.entries(obj));

alert( map.get('name') ); // John
```
è¿™é‡Œï¼Œ`Object.entries` è¿”å›äº†åŒ…å«é”®å€¼å¯¹çš„æ•°ç»„ï¼š`[ ["name","John"], ["age", 30] ]`, è¿™æ˜¯`Map` æ‰€éœ€è¦çš„


## Object.fromEntries: Map è½¬æˆ Object

æˆ‘ä»¬åˆšåˆšçœ‹åˆ°äº†æ€ä¹ˆåˆ©ç”¨ `Object.entries(obj)` æŠŠæ™®é€šå¯¹è±¡è½¬åŒ–æˆ `Map` 

è¿™é‡Œæœ‰ä¸ªç›¸å`Object.fromEntries` æ–¹æ³•ï¼š ç»™å®šä¸€ä¸ªåŒ…å«é”®å€¼å¯¹çš„æ•°ç»„ï¼Œå®ƒä¼šåˆ©ç”¨æ•°ç»„åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼š

```js run
let prices = Object.fromEntries([
  ['banana', 1],
  ['orange', 2],
  ['meat', 4]
]);

// now prices = { banana: 1, orange: 2, meat: 4 }

alert(prices.orange); // 2
```

æˆ‘ä»¬ä½¿ç”¨ `Object.fromEntries()` ä» `Map` ä¸­è·å–åˆ°ä¸€ä¸ªæ™®é€šå¯¹è±¡

æ¯”å¦‚.æˆ‘ä»¬åœ¨`Map` ä¸­å­˜å‚¨äº†æ•°æ®ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦æŠŠå®ƒä¼ é€’ç»™ç¬¬ä¸‰æ–¹ä»£ç ä»è€Œæš´éœ²å‡ºä¸€ä¸ªæ™®é€šå¯¹è±¡

æˆ‘ä»¬å¼€å§‹å§ï¼š

```js run
let map = new Map();
map.set('banana', 1);
map.set('orange', 2);
map.set('meat', 4);

let obj = Object.fromEntries(map.entries()); // åˆ›å»ºä¸€ä¸ªæ™®é€šå¯¹è±¡(*)

// å®Œæˆ!
// obj = { banana: 1, orange: 2, meat: 4 }

alert(obj.orange); // 2
```

è°ƒç”¨`map.entries()` ä¼šè¿”å›ä¸€ä¸ªé”®å€¼å¯¹æ•°ç»„ï¼Œåˆšåˆšå¥½æ˜¯`Object.fromEntries()` æ‰€éœ€è¦çš„æ ¼å¼

æˆ‘ä»¬å¯ä»¥æŠŠæ‰“ ï¼ˆ*ï¼‰è¿™ä¸€è¡Œç¼©çŸ­ï¼šå› ä¸º `Object.fromEntries` æœŸæœ›ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ä½œä¸ºå‚æ•°ã€‚æ²¡æœ‰å¿…è¦æ—¶æ•°ç»„ã€‚æ ‡å‡†çš„`map` è¿­ä»£è¿”å›é”®å€¼å¯¹è·Ÿ
 
 ```javascript
 let obj = Object.fromEntries(map); // çœç•¥ .entries() æ–¹æ³•
```
ä»¥ä¸Šä»£ç åšç€åŒæ ·çš„äº‹æƒ…ã€‚å› ä¸º`Object.fromEntries` æœŸæœ›ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œæ²¡æœ‰å¿…è¦æ˜¯æ•°ç»„ï¼Œæ ‡å‡†çš„`map`è¿­ä»£ä¼šè¿”å›è·Ÿ `map.entries()` æ‰€è¿”å›çš„ä¸€æ ·çš„é”®å€¼å¯¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªè·Ÿmapè¿”å›çš„ä¸€æ ·çš„é”®å€¼å¯¹å¯¹è±¡

## Set

`Set`æ˜¯ä¸€ä¸ªç‰¹æ®Šç±»å‹çš„é›†åˆ-â€œå€¼å¾—é›†åˆâ€ï¼ˆæ²¡æœ‰é”®ï¼‰ï¼Œæ¯ä¸ªå€¼åªå‡ºç°ä¸€æ¬¡

å®ƒçš„ä¸»è¦æ–¹æ³•æœ‰ï¼š

- `new Set(iterable)` --åˆ›å»ºä¸€ä¸ªé›†åˆï¼Œå¦‚æœæä¾›äº†`iterable`ï¼ˆå¯è¿­ä»£ï¼‰å¯¹è±¡(é€šå¸¸æ˜¯æ•°ç»„)ï¼Œå°†ä¼šæŠŠå®ƒä»¬æ”¾å…¥é›†åˆä¸­

- `set.add(value)` --æ·»åŠ ä¸€ä¸ªå€¼ã€‚å¹¶è¿”å›å½“å‰é›†åˆ

- `set.delete(value)` --ç§»é™¤å€¼ï¼Œå¦‚æœåœ¨å½“å‰è°ƒç”¨ä¸­ `value` å­˜åœ¨å°±è¿”å›`true`ï¼Œå¦åˆ™ä¸º `false`

- `set.has(value)` -- å¦‚æœ`value` å­˜åœ¨é›†åˆä¸­åˆ™è¿”å› `true` å¦åˆ™ä¸º`false`

- `set.clear()` -- ç§»é™¤é›†åˆé‡Œçš„æ‰€æœ‰å…ƒç´ ï¼ˆæ¸…ç©ºï¼‰

- `set.size` -- æ˜¯å…ƒç´ çš„æ•°é‡

ä¸»è¦çš„ç‰¹æ€§æ˜¯ä½¿ç”¨ç›¸åŒ`value`å¹¶é‡å¤è°ƒç”¨`set.add(value)`å°†ä¸ä¼šåšä»»ä½•äº‹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ¯ä¸ªå€¼åœ¨`Set` ä¸­åªå‡ºç°ä¸€æ¬¡çš„åŸå› 

ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰è®¿å®¢è¿›æ¥ï¼Œå¹¶å‘è®°ä½æ‰€æœ‰äººã€‚ä½†æ˜¯åŒä¸€ä¸ªè®¿å®¢ä¼šå¯¼è‡´é‡å¤è®¡ç®—ã€‚è®¿å®¢å¿…é¡»åªâ€œè®¡ç®—â€ä¸€æ¬¡

`Set`å°±æ˜¯ä¸ºè§£å†³ä¸Šé¢çš„é—®é¢˜è€Œæ¥ï¼š
 
 ```js run
 let set = new Set();
 
 let john = { name: "John" };
 let pete = { name: "Pete" };
 let mary = { name: "Mary" };
 
 // visits, some users come multiple times
 set.add(john);
 set.add(pete);
 set.add(mary);
 set.add(john);
 set.add(mary);
 
 // set keeps only unique values
 alert( set.size ); // 3
 
 for (let user of set) {
   alert(user.name); // John (then Pete and Mary)
 }
 ```

ä¾›`Set` é€‰æ‹©çš„æ˜¯ä¸ªæ•°ç»„ï¼Œä»¥ä¸Šä»£ç ä¼šä½¿ç”¨ [arr.find](mdn:js/find)æ¥æ£€æŸ¥æ¯ä¸ªæ’å…¥ã€‚ä½†æ˜¯æ€§èƒ½ä¸å¥½ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•ä¼šéå†æ•´ä¸ªæ•°ç»„æ¥æ£€æŸ¥æ¯ä¸ªå…ƒç´ ï¼Œ`Set` ä¼šåœ¨å†…éƒ¨è¿›è¡Œæ›´å¥½çš„ä¼˜åŒ–ä½œç‹¬ä¸€æ— äºŒçš„æ£€æŸ¥

## Set ä¸Šçš„è¿­ä»£

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`for..of` æˆ–è€…` forEach` æ¥å¾ªç¯ä¸€ä¸ªé›†åˆï¼š

```js run
let set = new Set(["oranges", "apples", "bananas"]);

for (let value of set) alert(value);

// the same with forEach:
set.forEach((value, valueAgain, set) => {
  alert(value);
});
```

è®°ä½æœ‰ä¸ªæœ‰è¶£çš„äº‹æƒ…ï¼Œ`forEach` çš„å›è°ƒå‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°ï¼šä¸€ä¸ª`value`,ç„¶åç¬¬äºŒä¸ªç›¸åŒçš„å€¼`valueAgain`,æœ€åä¸€ä¸ªæ˜¯ç›®æ ‡å¯¹è±¡ã€‚çš„ç¡®ï¼Œç›¸åŒçš„å€¼ä¼šåœ¨å‚æ•°é‡Œå‡ºç°ä¿©æ¬¡

é‚£æ˜¯ä¸ºäº†å…¼å®¹`Map` æ‰€ä»¥å›è°ƒä¹Ÿä¼ äº†3ä¸ªå‚æ•°ã€‚æ¯«æ— ç–‘é—®ï¼Œçœ‹èµ·æ¥æœ‰ç‚¹å¥‡æ€ªã€‚ä½†æ˜¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨ç‰¹å®šæƒ…å†µä¸‹æ›¿æ¢`Map`ä¸º`Set`ï¼Œæˆ–è€…ç›¸åã€‚

`Map` é‡Œé¢æœ‰çš„ç›¸åŒçš„è¿­ä»£æ–¹æ³•åœ¨`Set`é‡Œé¢ä¹Ÿæ”¯æŒ

- `set.keys()` -- è¿”å›å¯è¿­ä»£å¯¹è±¡çš„å€¼

- `set.values() `-- ç”¨æ³•åŒ `set.keys()`ï¼Œä¸ºäº†å…¼å®¹`Map`

- `set.entries()` -- è¿”å›å¯è¿­ä»£å¯¹è±¡`[value, value]`ï¼Œ ä¹Ÿæ˜¯ä¸ºäº†å…¼å®¹`Map` 


##æ€»ç»“

`Map` æ˜¯ä¸€ä¸ªå¸¦æœ‰å€¼çš„é”®çš„é›†åˆ

æ–¹æ³•å’Œå±æ€§ï¼š

- `new Map([iterable])` -- åˆ›å»ºé›†åˆ, ä½¿ç”¨å¯é€‰çš„å¸¦æœ‰é”®å€¼å¯¹çš„å¯è¿­ä»£å¯¹è±¡ (ä¾‹å¦‚æ•°ç»„)æ¥åˆå§‹åŒ–.

- `map.set(key, value)` -- æ ¹æ®é”®æ¥å­˜å‚¨å€¼

- `map.get(key)` -- ä¾æ®é”®æ¥è¿”å›å€¼ï¼Œå¦‚æœ `key` ä¸å­˜åœ¨ä¼šè¿”å› `undefined`

- `map.has(key)` -- å¦‚æœé”®å­˜åœ¨åˆ™è¿”å› `true` ï¼Œå¦åˆ™è¿”å›  `false`

- `map.delete(key)` --ä¾æ®é”®æ¥åˆ é™¤å€¼

- `map.clear()` --åˆ é™¤é›†åˆé‡Œé¢çš„æ‰€æœ‰æˆå‘˜

- `map.size` --è¿”å›å½“å‰å…ƒç´ çš„æ•°é‡

ä¸å¸¸è§„ `Object` ä¸åŒ:

- ä»»ä½•é”®ï¼ŒåŒ…æ‹¬å¯¹è±¡ä¹Ÿå¯ä»¥ä½œä¸º `Map` çš„é”®

- é¢å¤–çš„ä¾¿æ·æ–¹æ³•ï¼Œ`size` å±æ€§


`Set` --æ‰€æœ‰å•ç‹¬çš„å€¼çš„é›†åˆ

æ–¹æ³•å’Œå±æ€§ï¼š

- `new Set([iterable])` -- åˆ›å»ºä¸€ä¸ª `Set` é›†åˆï¼Œä½¿ç”¨å¯é€‰çš„çš„å¯è¿­ä»£å¯¹è±¡ (ä¾‹å¦‚æ•°ç»„)æ¥åˆå§‹åŒ–

- `set.add(value)` -- æ·»åŠ ä¸€ä¸ªå€¼ï¼ˆå¦‚æœè¯¥å€¼å·²ç»å­˜åœ¨ä¾¿ä»€ä¹ˆä¹Ÿä¸åšï¼‰ï¼Œè¿”å› `Set` é›†åˆæœ¬èº«

- `set.delete(value)` -- ç§»é™¤å€¼ï¼Œå¦‚æœå½“å‰ç¯å¢ƒè°ƒç”¨çš„æ—¶å€™è¯¥å€¼å­˜åœ¨åˆ™è¿”å› `true` ,å¦åˆ™è¿”å› `false`

- `set.has(value)` -- å¦‚æœè¯¥å€¼å­˜åœ¨ `Set` ä¸­åˆ™è¿”å› `true` ï¼Œå¦åˆ™è¿”å› `false`

- `set.clear()` -- ç§»é™¤ `Set` é‡Œé¢çš„æ‰€æœ‰æˆå‘˜

- `set.size` -- å…ƒç´ çš„ä¸ªæ•°

 `Map` å’Œ `Set` çš„è¿­ä»£æ€»æ˜¯æœ‰åºæ’å…¥,æ‰€ä»¥æˆ‘ä»¬ä¸èƒ½è¯´è¿™äº›é›†åˆæ˜¯æ— åºçš„ï¼Œä¹Ÿä¸èƒ½é‡æ–°æ’åºï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨å®ƒçš„æ•°å­—è·å–åˆ°æŸä¸ªå…ƒç´ 
 
 
## WeakMap å’Œ WeakSet

ä»[åƒåœ¾å›æ”¶æœºåˆ¶](https://zh.javascript.info/garbage-collection)è¿™ä¸€ç« èŠ‚ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒJavaScript å¼•æ“ä¼šæŠŠå¯ç”¨ï¼ˆå¯èƒ½ä¼šè¢«ç”¨ï¼‰çš„å€¼å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚

ä¾‹å¦‚ï¼š
```js run
let john = { name: "John" };

// å¯¹è±¡å¯ä»¥è¢«è®¿é—®, john æ˜¯è¯¥å¯¹è±¡çš„å¼•ç”¨

// è¦†ç›–å¼•ç”¨
john = null;

// è¯¥å¯¹è±¡å°†ä¼šä»å†…å­˜ä¸­ç§»é™¤
```

é€šå¸¸ï¼Œå¯¹è±¡çš„å±æ€§æˆ–è€…æ•°ç»„å…ƒç´ æˆ–è€…å…¶ä»–æ•°æ®ç»“æ„åœ¨è¢«è®¤ä¸ºå¯ç”¨çš„çš„æƒ…å†µä¸‹ä¼šè¢«ä¸€ç›´ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œè€Œè¯¥æ•°æ®ç»“æ„åœ¨å†…å­˜ä¸­ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æŠŠä¸€ä¸ªå¯¹è±¡æ”¾å…¥ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œå½“è¯¥æ•°ç»„å­˜åœ¨ï¼Œå³ä½¿æŠŠè¯¥å¯¹è±¡çš„å¼•ç”¨è¦†ç›–äº†ï¼Œè¯¥å¯¹è±¡ä¹Ÿä¼šå­˜åœ¨ã€‚

åƒè¿™æ ·ï¼š

```js run
let john = { name: "John" };

let array = [ john ];

john = null; // è¦†ç›–å¼•ç”¨

// john è¢«å­˜å‚¨åœ¨æ•°ç»„ä¸­, æ‰€ä»¥å®ƒä¸ä¼šè¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶
// æˆ‘ä»¬å¯ä»¥è¿™æ ·è®¿é—®å®ƒ array[0]
```
ç±»ä¼¼åœ°ï¼Œå¦‚æœæˆ‘ä»¬æŠŠä¸€ä¸ªå¯¹è±¡ä½œä¸ºå¸¸è§„ `Map` çš„é”®ï¼Œç„¶åå½“ `Map` å­˜åœ¨æ—¶ï¼Œè¯¥å¯¹è±¡ä¹Ÿä¼šå­˜åœ¨ã€‚å®ƒå¯èƒ½ä¸ä¼šè¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶å¹¶ä¸”å æ®ç€å†…å­˜

ä¾‹å¦‚ï¼š

```js run
let john = { name: "John" };

let map = new Map();
map.set(john, "...");

john = null; // è¦†ç›–å¼•ç”¨

// john è¢«å­˜å‚¨åœ¨ map çš„å†…éƒ¨,
// æˆ‘ä»¬å¯ä»¥è¿™æ ·è®¿é—®å®ƒï¼š map.keys()
```
 `WeakMap` åœ¨è¿™æ–¹é¢æœ‰å¾ˆå¤§ä¸åŒï¼Œå®ƒä¸ä¼šé˜»æ­¢åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶é‡è¦çš„å¯¹è±¡

è®©æˆ‘ä»¬é€šè¿‡ä¾‹å­æ¥çœ‹çœ‹ç€æ„å‘³ç€ä»€ä¹ˆ

## WeakMap

å’Œ `Map` çš„ç¬¬ä¸€ä¸ªä¸åŒç‚¹å°±æ˜¯ `WeakMap` çš„é”®å¿…é¡»æ˜¯å¯¹è±¡ï¼Œä¸èƒ½è¯•åŸå§‹å€¼ï¼š

```js run
let weakMap = new WeakMap();

let obj = {};

weakMap.set(obj, "ok"); // æ­£å¸¸æ‰§è¡Œ (ä»¥å¯¹è±¡ä½œä¸ºé”®)

// ä¸èƒ½ä½¿ç”¨å­—ç¬¦ä¸²ä½œä¸ºé”®
weakMap.set("test", "Whoops"); // é”™è¯¯ï¼Œå› ä¸º "test" ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡
```

ç°åœ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡ä½œä¸ºé”®å€¼æ”¾å…¥å…¶ä¸­ï¼Œå¦‚æœæ²¡æœ‰å…¶å®ƒå¼•ç”¨åœ¨è¯¥å¯¹è±¡ä¸Š-å®ƒå°±ä¼šä»å†…å­˜ä¸­ï¼ˆå’Œæ¥è‡ªé›†åˆé‡Œé¢ï¼‰è¢«è‡ªåŠ¨ç§»é™¤

```js run
let john = { name: "John" };

let weakMap = new WeakMap();
weakMap.set(john, "...");

john = null; // è¦†ç›–å¼•ç”¨

// john åœ¨å†…å­˜ä¸­è¢«ç§»é™¤!
```

æ¯”è¾ƒä¸€ä¸‹ä»¥ä¸Šä¾‹å­ä¸­çš„å¸¸è§„ `Map` ï¼Œç°åœ¨å¦‚æœ `john` ä»…ä»…æ˜¯ä½œä¸º `WeakMap` çš„é”®å­˜åœ¨æ—¶ - ä»–å°†ä¼šä»é›†åˆä¸­ï¼ˆå’Œå†…å­˜ï¼‰è¢«è‡ªåŠ¨åˆ é™¤ã€‚

`WeakMap` ä¸æ”¯æŒè¿­ä»£å’Œ `keys()`, `values()`,`entries()` æ–¹æ³•ã€‚æ‰€ä»¥æ²¡æœ‰åŠæ³•ä»å®ƒé‡Œé¢è·å–æ‰€æœ‰çš„é”®æˆ–è€…å€¼ã€‚

`WeakMap` ä»…ä»…åªæœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š

- `weakMap.get(key)`
- `weakMap.set(key, value)`
- `weakMap.delete(key)`
- `weakMap.has(key)`

ä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„é™åˆ¶å‘¢ï¼Ÿé‚£æ˜¯å‡ºäºæŠ€æœ¯åŸå› ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡å·²ç»å¤±å»æ‰€æœ‰å…¶ä»–çš„å¼•ç”¨ï¼ˆå°±åƒä¸Šé¢çš„ `john` ä¸€æ ·ï¼‰ï¼Œç„¶åå®ƒä¼šè¢«åƒåœ¾å›æ”¶æœºåˆ¶è‡ªåŠ¨å›æ”¶ã€‚ä½†æ˜¯ä»æŠ€æœ¯ä¸Šæ¥è¯´å¹¶ä¸èƒ½ç¡®å®šæ¸…ç†ä¼šåœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿã€‚

ä»¥ä¸Šç”± JavaScript å¼•æ“å†³å®šã€‚å®ƒå¯èƒ½ä¼šé€‰æ‹©ç«‹å³æ¸…ç†æ¥ä¼˜åŒ–å†…å­˜æˆ–è€…ç­‰å¾…å’Œå‘ç”Ÿæ›´å¤šçš„åˆ é™¤æ—¶æ‰æ¸…ç†ã€‚æ‰€ä»¥ï¼Œä»æŠ€æœ¯ä¸Šï¼Œå¹¶ä¸èƒ½çŸ¥é“ä¸€ä¸ª `WeakMap` çš„å½“å‰å…ƒç´ çš„ä¸ªæ•°ã€‚å¼•æ“å¯èƒ½ä¼šæ¸…ç†æ‰å®ƒä¹Ÿå¯èƒ½ä¸ä¼šï¼Œæˆ–è€…æ¸…ç†æ‰ä¸€éƒ¨åˆ†ã€‚ç”±äºè¿™ä¸ªåŸå› ï¼Œè®¿é—®æ‰€æœ‰é”®/å€¼çš„æ–¹æ³•ä¸èƒ½è¢«æ”¯æŒã€‚

ç°åœ¨æˆ‘ä»¬åœ¨å“ªé‡Œä¼šéœ€è¦è¿™æ ·çš„æ•°æ®ç»“æ„å‘¢ï¼Ÿ

## ä½¿ç”¨æ¡ˆä¾‹ï¼š é™„åŠ æ•°æ®

`WeakMap` çš„ä¸»è¦åº”ç”¨é¢†åŸŸæ˜¯åœ¨ä¸€ç§é™„åŠ æ•°æ®å­˜å‚¨

å¦‚æœæˆ‘ä»¬åœ¨å¤„ç†ä¸€ä¸ªâ€œå±äºâ€å…¶å®ƒä»£ç çš„å¯¹è±¡ï¼Œç”šè‡³å¯èƒ½æ˜¯ç¬¬ä¸‰æ–¹åº“ï¼Œå°±æœ‰å¯èƒ½å‚¨å­˜ä¸€äº›ç›¸å…³è”çš„æ•°æ®ï¼Œå®ƒä»…ä»…åœ¨è¯¥å¯¹è±¡å­˜åœ¨æ—¶æ‰å­˜åœ¨ - `WeakMap`å°±æ˜¯æˆ‘ä»¬çœŸæ­£éœ€è¦çš„ç»“æ„ã€‚

æˆ‘ä»¬æŠŠæŸäº›æ•°æ®æ”¾å…¥åˆ° `WeakMap` ä¸­ï¼Œå¹¶ä½¿ç”¨å¯¹è±¡ä½œä¸ºé”®ï¼Œå½“è¯¥å¯¹è±¡è¢«å›æ”¶æ—¶ï¼Œæ”¹æ•°æ®ä¹Ÿä¼šè‡ªåŠ¨æ¶ˆå¤±ã€‚

```js run
weakMap.set(john, "secret documents");
// å¦‚æœ john ä¸å­˜åœ¨äº†, secret documents ä¹Ÿä¼šè‡ªåŠ¨é”€æ¯
```

è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚

æ¯”å¦‚ï¼Œæˆ‘ä»¬æœ‰ä¸€æ®µä»£ç ä¸»è¦è®°å½•ç”¨æˆ·è®¿é—®çš„æ¬¡æ•°ã€‚è¯¥ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªmapç»“æ„ä¸­ï¼šç”¨æˆ·å¯¹è±¡ä½œä¸ºé”®ï¼Œæ¬¡æ•°ä½œä¸ºå€¼ã€‚å½“ç”¨æˆ·ç¦»å¼€ï¼ˆä¹Ÿå°±æ˜¯ä»–çš„å¯¹è±¡è¢«å›æ”¶ï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿä¸éœ€è¦å†å­˜å‚¨è®¿é—®æ¬¡æ•°äº†ã€‚

è¿™é‡Œæœ‰ä¸ªä½¿ç”¨ `Map` æ¥è®¡ç®—çš„å‡½æ•°ï¼š

```js run
// ğŸ“ visitsCount.js
let visitsCountMap = new Map(); // map: user => è®¿é—®æ¬¡æ•°

// å¢åŠ è®¿é—®æ¬¡æ•°
function countUser(user) {
  let count = visitsCountMap.get(user) || 0;
  visitsCountMap.set(user, count + 1);
}
```
ç„¶åè¿™é‡Œæ˜¯ä»£ç çš„å¦å¤–ä¸€éƒ¨åˆ†ï¼Œå…¶å®ƒæ–‡ä»¶å¯èƒ½ä¼šä½¿ç”¨å®ƒï¼š

```js run
// ğŸ“ main.js
let john = { name: "John" };

countUser(john); // è®¡ç®—ä»–çš„è®¿é—®æ¬¡æ•°
countUser(john);

// ç„¶å john ç¦»å¼€æˆ‘ä»¬
john = null;

```

ç°åœ¨ `john` å¯¹è±¡åº”è¯¥è¢«å›æ”¶ï¼Œä½†æ˜¯å®ƒè¿˜ç•™åœ¨äº†å†…å­˜ä¸­ï¼Œå› ä¸ºå®ƒè¢«ä½œä¸ºäº† `visitsCountMap` çš„é”®ã€‚

å½“ç§»é™¤ç”¨æˆ·çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ¸…ç† `visitsCountMap`ï¼Œå¦åˆ™å®ƒå°†ä¼šåœ¨å†…å­˜ä¸­æ— é™å¢åŠ ã€‚ è¿™æ ·çš„æ¸…ç†åœ¨å¤æ‚çš„æ¶æ„ä¸­ä¼šå˜æˆå†—ä½™çš„ä»»åŠ¡ã€‚

æˆ‘ä»¬é€šè¿‡åˆ‡æ¢æˆ `WeakMap` æ¥æ›¿ä»£å®ƒä»è€Œé¿å…ä¸Šé¢æåˆ°çš„é—®é¢˜:

```js run
// ğŸ“ visitsCount.js
let visitsCountMap = new WeakMap(); // weakmap: user => è®¿é—®æ¬¡æ•°

// å¢åŠ è®¿é—®æ¬¡æ•°
function countUser(user) {
  let count = visitsCountMap.get(user) || 0;
  visitsCountMap.set(user, count + 1);
}
```

ç°åœ¨æˆ‘ä»¬ä¸å¿…å»æ¸…ç† `visitsCountMap` äº†ï¼Œåœ¨é™¤äº†ä½œä¸º `WeakMap` çš„é”®ä¹‹å¤–ï¼Œ `john` å¯¹è±¡ä¹‹åå°†ä¸èƒ½è¢«å…¶å®ƒæ‰€æœ‰é€”å¾„ä½¿ç”¨

## ä½¿ç”¨æ¡ˆä¾‹ï¼š ç¼“å­˜

å…¶å®ƒå¾ˆå¸¸ç”¨çš„ä¾‹å­å°±æ˜¯ç¼“å­˜ï¼š å½“ä¸€ä¸ªå‡½æ•°ç»“æœåº”è¯¥è¢«è®°ä½ï¼ˆâ€œç¼“å­˜â€ï¼‰çš„æ—¶å€™ï¼Œæ‰€ä»¥å°†æ¥è°ƒç”¨åŒä¸€ä¸ªå¯¹è±¡é‡ç”¨å®ƒã€‚

æˆ‘ä»¬ä½¿ç”¨ `Map` æ¥å­˜å‚¨ç»“æœï¼Œåƒè¿™æ ·ï¼š

```js run
// ğŸ“ cache.js
let cache = new Map();

// è®¡ç®—å¹¶è®°ä½ç»“æœ
function process(obj) {
  if (!cache.has(obj)) {
    let result = /* ç»“æœçš„è®¡ç®— */ obj;

    cache.set(obj, result);
  }

  return cache.get(obj);
}

// ç°åœ¨ä½¿ç”¨å…¶å®ƒæ–‡ä»¶çš„ process() æ–¹æ³•:

// ğŸ“ main.js
let obj = {/* è®©æˆ‘ä»¬æ¥å®šä¹‰ä¸€ä¸ªå¯¹è±¡ */};

let result1 = process(obj); // è¢«è®¡ç®—

// ...ä¹‹å, æ¥è‡ªå…¶å®ƒåœ°æ–¹çš„ä»£ç å—...
let result2 = process(obj); // ä»ç¼“å­˜ä¸­æ‹¿åˆ°è®°ä½çš„ç»“æœ

// ...ä¹‹å, å½“è¿™ä¸ªå¯¹è±¡ä¸å†è¢«éœ€è¦çš„æ—¶å€™:
obj = null;

alert(cache.size); // 1 (wow! è¿™ä¸ªå¯¹è±¡ä¾ç„¶åœ¨ç¼“å­˜ä¸­, å æ®å†…å­˜!)
```

å¯¹äºç›¸åŒå¯¹è±¡å¤šæ¬¡è°ƒç”¨ `process(obj)` æ–¹æ³•ï¼Œä»–åªè®¡ç®—ç¬¬ä¸€æ¬¡ï¼Œä¹‹åæ˜¯ä»ç¼“å­˜è·å–ã€‚è¿™æ ·çš„ç¼ºç‚¹å°±æ˜¯å½“è¯¥å¯¹è±¡ä¸åœ¨éœ€è¦çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ¸…ç† `clean` 

å¦‚æœæˆ‘ä»¬ä½¿ç”¨ `WeakMap` æ¥ä»£æ›¿ `Map` ï¼Œç„¶åè¿™äº›é—®é¢˜å°±ä¼šæ¶ˆå¤±ï¼šå½“è¯¥å¯¹è±¡è¢«å›æ”¶æ—¶ï¼Œç¼“å­˜çš„ç»“æœå°†ä¼šä»å†…å­˜ä¸­è‡ªåŠ¨è¢«ç§»é™¤

```js run

// ğŸ“ cache.js
let cache = new WeakMap();

// calculate and remember the result
function process(obj) {
  if (!cache.has(obj)) {
    let result = /* calculate the result for */ obj;

    cache.set(obj, result);
  }

  return cache.get(obj);
}

// ğŸ“ main.js
let obj = {/* some object */};

let result1 = process(obj);
let result2 = process(obj);

// ...later, when the object is not needed any more:
obj = null;

// Can't get cache.size, as it's a WeakMap,
// but it's 0 or soon be 0
// When obj gets garbage collected, cached data will be removed as well

```
## WeakSet

`WeakSet` çš„è¡¨ç°ä¹Ÿç›¸ä¼¼ï¼š

- å®ƒç±»ä¼¼äº `Set` ï¼Œä½†æ˜¯æˆ‘ä»¬ä»…ä»…æ·»åŠ å¯¹è±¡åˆ° `WeakSet` é‡Œ(è€Œä¸æ˜¯åŸå§‹å€¼)

- é›†åˆé‡Œé¢å­˜åœ¨è¯¥å¯¹è±¡å½“å®ƒå¯ä»¥ä»å…¶ä»–åœ°æ–¹è·å–

-è·Ÿ `Set` ä¸€æ ·ï¼Œ`WeakSet` ä¹Ÿæ”¯æŒ `add`, `has` , `delete` æ–¹æ³•ï¼Œä½†æ˜¯ä¸æ”¯æŒ `size`,`key()` å’Œè¿­ä»£

å˜â€œå¼±â€çš„åŒæ—¶ï¼Œå®ƒä¹Ÿè¢«ç”¨ä½œé™„åŠ å­˜å‚¨ã€‚ä½†æ˜¯ä¸é€‚åˆä»»æ„æ•°æ®ï¼Œè€Œæ˜¯å› ä¸ºâ€œæ˜¯ / å¦â€çš„åŸå› .ä¸€ä¸ª `WeakSet` çš„æˆå‘˜å¯èƒ½æ„å‘³ç€å¯¹è±¡çš„å…¶å®ƒ

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ç”¨æˆ·åˆ° `WeakSet` æ¥è¿½è¸ªè°è®¿é—®äº†æˆ‘ä»¬çš„ç½‘ç«™ï¼š

```js run
let visitedSet = new WeakSet();

let john = { name: "John" };
let pete = { name: "Pete" };
let mary = { name: "Mary" };

visitedSet.add(john); // John visited us
visitedSet.add(pete); // Then Pete
visitedSet.add(john); // John again

// visitedSet ç°åœ¨æœ‰2ä¸ªç”¨æˆ·

//  æ£€æŸ¥ John æ˜¯å¦è®¿é—®è¿‡?
alert(visitedSet.has(john)); // true

// æ£€æŸ¥ Mary æ˜¯å¦è®¿é—®è¿‡?
alert(visitedSet.has(mary)); // false

john = null;

// visitedSet å°†ä¼šè¢«è‡ªåŠ¨æ¸…é™¤
```

`WeakMap ` å’Œ `WeakSet`æœ€æ˜¾è‘—çš„é™åˆ¶å°±æ˜¯ç¼ºä¹è¿­ä»£ï¼Œå¹¶ä¸”ä¸èƒ½è·å–å½“å‰æ‰€æœ‰çš„å†…å®¹ã€‚è¿™å¯èƒ½ä¼šé€ æˆå¾ˆå¤§çš„ä¸ä¾¿ï¼Œä½†æ˜¯è¿™å¹¶ä¸ä¼šé˜»æ­¢ `WeakMap/WeakSet` åšä¸»è¦çš„äº‹æƒ…-åœ¨å¦ä¸€ä¸ªåœ°æ–¹å­˜å‚¨/ç®¡ç†çš„å¯¹è±¡çš„â€œé™„åŠ â€å­˜å‚¨æ•°æ®ã€‚

## æ€»ç»“

`WeakMap` æ˜¯ä¸ªç±»ä¼¼äº `Map` çš„åªå…è®¸å¯¹è±¡ä½œä¸ºé”®å’Œé€šè¿‡å…¶å®ƒé€”å¾„ä½¿å¯¹è±¡å˜æˆä¸å¯ç”¨çš„æ—¶å€™å°±ä¼šé©¬ä¸Šç§»é™¤æ‰€æœ‰å…³è”çš„é”®çš„é›†åˆ

`WeakSet` æ˜¯ä¸ªç±»ä¼¼äº `Set` çš„åªå­˜å‚¨å¯¹è±¡å’Œç§»é™¤ä¸€æ—¦é€šè¿‡å…¶å®ƒé€”å¾„ä½¿å…¶å˜å¾—ä¸å¯ç”¨çš„å¯¹è±¡

å®ƒä»¬ä¿©ä¸ªéƒ½ä¸æ”¯æŒè·å–æ‰€æœ‰é”®å’Œå€¼å¾—æ–¹æ³•æˆ–è€…å±æ€§ï¼Œåªå…è®¸ä¸ªåˆ«æ“ä½œã€‚

`WeakMap` å’Œ `WeakSet` è¢«ç”¨è®¤ä¸ºæ˜¯é™¤äº†â€ä¸»è¦â€œå¯¹è±¡å­˜å‚¨ä¹‹å¤–çš„â€œç¬¬äºŒâ€æ•°æ®ç»“æ„ï¼Œä¸€æ—¦å¯¹è±¡åœ¨ä¸»è¦å­˜å‚¨ä¸­è¢«ç§»é™¤ï¼Œå¦‚æœè¯¥å¯¹è±¡ä»…ä»…æ˜¯å­˜å‚¨ä¸º `WeakMap` æˆ–è€… `WeakSet` çš„é”®çš„æ—¶å€™ï¼Œå®ƒå°±ä¼šè¢«è‡ªåŠ¨æ¸…ç†ã€‚
